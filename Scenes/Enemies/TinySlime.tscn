[gd_scene load_steps=14 format=3 uid="uid://d1o20s574nwoy"]

[ext_resource type="Texture2D" uid="uid://c6secmlambsaa" path="res://Assets/Entities/Monster&Giant/Animations/Tiny Slime/Idle/TinySlimeIdle1.png" id="1_t87d1"]
[ext_resource type="Texture2D" uid="uid://cyoyurtjjpega" path="res://Assets/Entities/Monster&Giant/Animations/Tiny Slime/Idle/TinySlimeIdle2.png" id="2_pvcks"]
[ext_resource type="Texture2D" uid="uid://xeufoelo72cg" path="res://Assets/Entities/Monster&Giant/Animations/Tiny Slime/Idle/TinySlimeIdle3.png" id="3_qldbt"]
[ext_resource type="Texture2D" uid="uid://bsxdcebmat6ro" path="res://Assets/Entities/Monster&Giant/Animations/Tiny Slime/Idle/TinySlimeIdle4.png" id="4_12sjh"]

[sub_resource type="GDScript" id="GDScript_pa037"]
script/source = "extends CharacterBody2D

@onready var Animation_TinySlime = $Animation_TinySlime
@onready var Spr_TinySlime = $Spr_TinySlime

const MOVE_SPEED = 50
const ORBIT_SPEED = 1
const ORBIT_CHANGE_INTERVAL_MIN = 1.0
const ORBIT_CHANGE_INTERVAL_MAX = 3.0

const ATTACK_DISTANCE = 45
const ATTACK_SPEED = 100
const ATTACK_TIMEOUT = 0.6
const ATTACK_DAMAGE = 1

const RETREAT_DISTANCE = 60
const RETREAT_SPEED = 70

var OrbitDistance = 25
var OrbitAngle = 0

var NextDirection_ChangeTime = 0
var OrbitDirection = 1

var attack_timer = 0
var is_attacking = false
var is_retreating = false

var is_player_detected: bool = false
var Player

var Lives = 3
var Hitting = false

var RandomMoveDirection = Vector2.ZERO
var NextRandomMoveChangeTime = 0

var current_room

signal enemie_defeated

func Move(delta):
	if is_player_detected:
		if Time.get_ticks_msec() > NextDirection_ChangeTime:
			OrbitDirection *= -1
			NextDirection_ChangeTime = Time.get_ticks_msec() + randi_range(ORBIT_CHANGE_INTERVAL_MIN, ORBIT_CHANGE_INTERVAL_MAX) * 1000
		
		OrbitAngle += OrbitDirection * ORBIT_SPEED * delta + randi_range(-0.1, 0.1)
		
		var DistanceVariation = randf_range(-0.35, 0.35)
		var _offset = Vector2(cos(OrbitAngle), sin(OrbitAngle)) * (OrbitDistance + DistanceVariation)
		
		var TargetPos = Player.get_node(\"PlayerPoint\").global_position + Vector2(cos(OrbitAngle), sin(OrbitAngle)) * (OrbitDistance + DistanceVariation)
		
		var move_direction = (TargetPos - position).normalized()
		
		velocity = move_direction * MOVE_SPEED
		move_and_slide()
	else:
		if Time.get_ticks_msec() > NextRandomMoveChangeTime:
			RandomMoveDirection = Vector2(randf() * 2.0 - 1.0, randf() * 2.0 - 1.0).normalized()
			NextRandomMoveChangeTime = Time.get_ticks_msec() + randi_range(ORBIT_CHANGE_INTERVAL_MIN, ORBIT_CHANGE_INTERVAL_MAX) * 1000
		
		velocity = RandomMoveDirection * MOVE_SPEED
		move_and_slide()
		
		if not (current_room.rect.encloses(Rect2(position - Vector2(8, 8), Vector2(16, 16)))):
			RandomMoveDirection = -RandomMoveDirection
			position.x = clamp(position.x, current_room.rect.position.x, current_room.rect.end.x)
			position.y = clamp(position.y, current_room.rect.position.y, current_room.rect.end.y)
		
		if (get_slide_collision_count() > 0): 
			RandomMoveDirection = Vector2(randf() * 2.0 - 1.0, randf() * 2.0 - 1.0).normalized()
			NextRandomMoveChangeTime = Time.get_ticks_msec() + randi_range(ORBIT_CHANGE_INTERVAL_MIN, ORBIT_CHANGE_INTERVAL_MAX) * 1000

func Animate():
	if Player and is_player_detected:
		Spr_TinySlime.flip_h = position.x > Player.position.x
	
	if (is_player_detected):
		Animation_TinySlime.play(\"Walk\")
	else:
		Animation_TinySlime.play(\"Idle\")

func PlayerDetected(body):
	if body.is_in_group(\"Player\"):
		Player = body
		
		is_player_detected = true

func PlayerUndetectable(body):
	if body.is_in_group(\"Player\"):
		is_player_detected = false

func Attack(delta):
	if (is_player_detected and not is_attacking and not is_retreating):
		var distance_to_player = position.distance_to(Player.position)
		
		if (distance_to_player < ATTACK_DISTANCE):
			is_attacking = true
			attack_timer = ATTACK_TIMEOUT

	if (is_attacking):
		attack_timer -= delta
		if (attack_timer <= 0 or Hitting):
			is_attacking = false
			is_retreating = true
			return
			
		var attack_direction = (Player.position - position).normalized()
		
		velocity = attack_direction * ATTACK_SPEED
		move_and_slide()

		if (position.distance_to(Player.position) < 15 and is_attacking):
			is_attacking = false
			is_retreating = true
			
			if (!Player.TakingDamage): Player.Hit(ATTACK_DAMAGE)

	elif is_retreating:
		var retreat_direction = (position - Player.position).normalized()
		
		velocity = retreat_direction * RETREAT_SPEED
		move_and_slide()
		
		if position.distance_to(Player.position) > RETREAT_DISTANCE:
			is_retreating = false

func Hit(Damage):
	if (Hitting): return
	
	Hitting = true
	Lives -= Damage
	
	if (Lives <= 0):
		Animation_TinySlime.play(\"Death\")
		
		await Animation_TinySlime.animation_finished
		
		emit_signal(\"enemie_defeated\", current_room)
		queue_free()
	else:
		Animation_TinySlime.play(\"Hit\")
		
		await Animation_TinySlime.animation_finished
	
	Hitting = false

func _physics_process(delta):
	if (!Hitting):
		Animate()
	
	Move(delta)
	Attack(delta)
"

[sub_resource type="CircleShape2D" id="CircleShape2D_vs4mt"]
radius = 4.0

[sub_resource type="Animation" id="Animation_o56xy"]
resource_name = "Death"
length = 0.3
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("Spr_TinySlime/ColorBox_TinySlime:color")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.1, 0.3),
"transitions": PackedFloat32Array(1, 1, 1),
"update": 0,
"values": [Color(1, 1, 1, 0), Color(1, 1, 1, 1), Color(1, 1, 1, 0)]
}
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("Spr_TinySlime:modulate")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0, 0.3),
"transitions": PackedFloat32Array(1, 1),
"update": 0,
"values": [Color(1, 1, 1, 1), Color(1, 1, 1, 0)]
}

[sub_resource type="Animation" id="Animation_0b6l8"]
resource_name = "Hit"
length = 0.3
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("Spr_TinySlime/ColorBox_TinySlime:color")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.1, 0.3),
"transitions": PackedFloat32Array(1, 1, 1),
"update": 0,
"values": [Color(1, 1, 1, 0), Color(1, 1, 1, 1), Color(1, 1, 1, 0)]
}

[sub_resource type="Animation" id="Animation_scc4i"]
resource_name = "Idle"
length = 1.5
loop_mode = 1
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("Spr_TinySlime:texture")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.3, 1.1, 1.3),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 1,
"values": [ExtResource("1_t87d1"), ExtResource("2_pvcks"), ExtResource("3_qldbt"), ExtResource("4_12sjh")]
}

[sub_resource type="Animation" id="Animation_cwtof"]
length = 0.001
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("Spr_TinySlime:texture")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 1,
"values": [ExtResource("1_t87d1")]
}
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("Spr_TinySlime:position")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Vector2(-2, 0)]
}
tracks/2/type = "value"
tracks/2/imported = false
tracks/2/enabled = true
tracks/2/path = NodePath("Collision_TinySlime:position")
tracks/2/interp = 1
tracks/2/loop_wrap = true
tracks/2/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Vector2(-2, 4)]
}
tracks/3/type = "value"
tracks/3/imported = false
tracks/3/enabled = true
tracks/3/path = NodePath("Spr_TinySlime:scale")
tracks/3/interp = 1
tracks/3/loop_wrap = true
tracks/3/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Vector2(1, 1)]
}
tracks/4/type = "value"
tracks/4/imported = false
tracks/4/enabled = true
tracks/4/path = NodePath("Spr_TinySlime/ColorBox_TinySlime:color")
tracks/4/interp = 1
tracks/4/loop_wrap = true
tracks/4/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Color(1, 1, 1, 0)]
}
tracks/5/type = "value"
tracks/5/imported = false
tracks/5/enabled = true
tracks/5/path = NodePath("Spr_TinySlime:modulate")
tracks/5/interp = 1
tracks/5/loop_wrap = true
tracks/5/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Color(1, 1, 1, 1)]
}

[sub_resource type="Animation" id="Animation_pcoq0"]
resource_name = "Walk"
length = 1.2
loop_mode = 1
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("Spr_TinySlime:position")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.3, 0.6, 0.9),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 0,
"values": [Vector2(-2, 0), Vector2(-2, -1), Vector2(-2, 0), Vector2(-2, 1)]
}
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("Collision_TinySlime:position")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0, 0.3, 0.6, 0.9),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 0,
"values": [Vector2(-2, 4), Vector2(-2, 3), Vector2(-2, 4), Vector2(-2, 5)]
}
tracks/2/type = "value"
tracks/2/imported = false
tracks/2/enabled = true
tracks/2/path = NodePath("Spr_TinySlime:scale")
tracks/2/interp = 1
tracks/2/loop_wrap = true
tracks/2/keys = {
"times": PackedFloat32Array(0, 0.3, 0.6, 0.9),
"transitions": PackedFloat32Array(1, 1, 1, 1),
"update": 0,
"values": [Vector2(1, 1), Vector2(0.95, 1.05), Vector2(1, 1), Vector2(1.05, 0.95)]
}
tracks/3/type = "value"
tracks/3/imported = false
tracks/3/enabled = true
tracks/3/path = NodePath("Spr_TinySlime:texture")
tracks/3/interp = 1
tracks/3/loop_wrap = true
tracks/3/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 1,
"values": [ExtResource("1_t87d1")]
}

[sub_resource type="AnimationLibrary" id="AnimationLibrary_oijv6"]
_data = {
"Death": SubResource("Animation_o56xy"),
"Hit": SubResource("Animation_0b6l8"),
"Idle": SubResource("Animation_scc4i"),
"RESET": SubResource("Animation_cwtof"),
"Walk": SubResource("Animation_pcoq0")
}

[sub_resource type="CircleShape2D" id="CircleShape2D_w2r88"]
radius = 102.044

[node name="TinySlime" type="CharacterBody2D" groups=["Enemies"]]
y_sort_enabled = true
collision_layer = 8
script = SubResource("GDScript_pa037")

[node name="Spr_TinySlime" type="Sprite2D" parent="."]
clip_children = 2
position = Vector2(-2, 0)
texture = ExtResource("1_t87d1")

[node name="ColorBox_TinySlime" type="ColorRect" parent="Spr_TinySlime"]
offset_left = -7.5
offset_top = -4.0
offset_right = 7.5
offset_bottom = 10.0
color = Color(1, 1, 1, 0)

[node name="Collision_TinySlime" type="CollisionShape2D" parent="."]
position = Vector2(-2, 4)
shape = SubResource("CircleShape2D_vs4mt")

[node name="Animation_TinySlime" type="AnimationPlayer" parent="."]
libraries = {
"": SubResource("AnimationLibrary_oijv6")
}

[node name="PlayerDetectArea" type="Area2D" parent="."]
collision_layer = 4
collision_mask = 2

[node name="AreaofDetection" type="CollisionShape2D" parent="PlayerDetectArea"]
position = Vector2(-2, 3)
shape = SubResource("CircleShape2D_w2r88")

[connection signal="body_entered" from="PlayerDetectArea" to="." method="PlayerDetected"]
[connection signal="body_exited" from="PlayerDetectArea" to="." method="PlayerUndetectable"]
